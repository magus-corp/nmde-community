#!/usr/bin/env python3
import os
import sys

# --- Venv Self-Execution ---
VENV_PYTHON = os.path.expanduser("~/.magustui/.venv/bin/python")
if sys.executable != VENV_PYTHON:
    if os.path.exists(VENV_PYTHON):
        os.execv(VENV_PYTHON, [VENV_PYTHON] + sys.argv)
    else:
        print(f"Error: MagusTUI virtual environment not found at {VENV_PYTHON}", file=sys.stderr)
        sys.exit(1)
# --- End Venv Self-Execution ---

import subprocess
from rich.console import Console
from rich.panel import Panel
from rich.theme import Theme

def main():
    """
    A spell to awaken the ComfyUI, a powerful golem for image generation.
    This incantation will summon a Docker container and bind it to the necessary
    ports and volumes, allowing the Magus to create wondrous images.
    """
    custom_theme = Theme({
        "info": "bold cyan",
        "success": "bold green",
        "error": "bold red",
        "path": "blue"
    })
    console = Console(theme=custom_theme)

    home_dir = os.path.expanduser("~")
    models_dir = os.path.join(home_dir, "comfyui_launcher_models")
    projects_dir = os.path.join(home_dir, "comfyui_launcher_projects")

    os.makedirs(models_dir, exist_ok=True)
    os.makedirs(projects_dir, exist_ok=True)

    console.print(Panel("Starting ComfyUI Docker container", style="info"))
    console.print(f"Models directory: [path]{models_dir}[/path]")
    console.print(f"Projects directory: [path]{projects_dir}[/path]")

    docker_command = [
        "docker", "run", "--gpus", "all", "--rm", "--name", "comfyui_launcher",
        "-p", "4000-4100:4000-4100",
        "-v", f"{models_dir}:/app/server/models",
        "-v", f"{projects_dir}:/app/server/projects",
        "-it", "thecooltechguy/comfyui_launcher"
    ]

    try:
        subprocess.run(docker_command, check=True)
        console.print("ComfyUI container stopped.", style="success")
    except subprocess.CalledProcessError as e:
        console.print("Error running ComfyUI container.", style="error")
    except FileNotFoundError:
        console.print("Error: 'docker' command not found. Is Docker installed and in your PATH?", style="error")

if __name__ == "__main__":
    main()