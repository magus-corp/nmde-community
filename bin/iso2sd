#!/bin/bash
#
# Writes an ISO file to a specified SD card or USB device.
#
# Usage: iso2sd <input_file.iso> <output_device>
# Example: iso2sd ~/Downloads/ubuntu.iso /dev/sda

set -euo pipefail

if [ "$#" -ne 2 ]; then
  echo "Usage: iso2sd <input_file> <output_device>"
  echo "Example: iso2sd ~/Downloads/ubuntu-25.04-desktop-amd64.iso /dev/sda"
  echo -e "\nAvailable devices:"
  lsblk -d -o NAME,SIZE,MODEL | grep -E '^sd[a-z]|^nvme[0-9]n[0-9]'
  exit 1
fi

INPUT_FILE="$1"
OUTPUT_DEVICE="$2"

if [ ! -f "$INPUT_FILE" ]; then
  echo "Error: Input file not found at '$INPUT_FILE'"
  exit 1
fi

if [ ! -b "$OUTPUT_DEVICE" ]; then
    # Check if the user provided a simple name like 'sda' and prepend '/dev/'
    if [ -b "/dev/$OUTPUT_DEVICE" ]; then
        OUTPUT_DEVICE="/dev/$OUTPUT_DEVICE"
    else
        echo "Error: Output device not found at '$OUTPUT_DEVICE'"
        exit 1
    fi
fi

echo "WARNING: This will overwrite all data on $OUTPUT_DEVICE."
read -p "Are you sure you want to continue? (y/N): " confirm
if [[ "$confirm" != [yY] ]]; then
  echo "Operation cancelled."
  exit 0
fi

echo "Writing '$INPUT_FILE' to '$OUTPUT_DEVICE'..."
sudo dd bs=4M status=progress oflag=sync if="$INPUT_FILE" of="$OUTPUT_DEVICE"

echo "Ejecting device..."
sudo eject "$OUTPUT_DEVICE"

echo "Operation complete."
